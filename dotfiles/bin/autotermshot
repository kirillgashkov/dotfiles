#!/usr/bin/env zsh

redo=""

allow_pane_capture=0

output_file=

load_args() {
    while [[ "$#" -gt 0 ]]; do
        case "$1" in
            -p|--redo-pane)
                redo="pane"
                shift
                ;;
            -e|--redo-edit)
                redo="edit"
                shift
                ;;
            -s|--redo-shot)
                redo="shot"
                shift
                ;;
            -a|--allow-pane-capture)
                allow_pane_capture=1
                shift
                ;;
            -o|--output)
                output_file="$2"
                shift 2
                ;;
            -*)
                echo >&2 "$(tput bold)$(tput setaf 1)Error:$(tput sgr0) Unknown option: $1"
                exit 1
                ;;
            *)
                echo >&2 "$(tput bold)$(tput setaf 1)Error:$(tput sgr0) Unexpected argument: $1"
                exit 1
                ;;
        esac
    done

    if [[ -z "$output_file" ]]; then
        echo >&2 "$(tput bold)$(tput setaf 1)Error:$(tput sgr0) Option '-o|--output' is required."
        exit 1
    fi
}


raw_pane_file=
pane_file=
shot_file=

find_files_on_exit() {}
find_files() {
    raw_pane_file="$(mktemp -t autotermshot)"
    pane_file="${output_file}.autotermshot/pane.txt"
    shot_file="$output_file"

    find_files_on_exit() {
        rm -f "$raw_pane_file";
    }
}


on_exit() {
    find_files_on_exit;
}

trap 'on_exit' EXIT
trap 'on_exit; trap - TERM; kill -TERM "$$"' TERM
trap 'on_exit; trap - INT; kill -INT "$$"' INT


main() {
    load_args "$@"
    find_files
}

main "$@"
